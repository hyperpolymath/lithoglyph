// SPDX-License-Identifier: PMPL-1.0-or-later

/**
 * FormDB Client for Strapi
 *
 * HTTP client wrapper for FormDB API within Strapi context
 */

open FormDB_Strapi_Types

/** Node.js fetch binding */
@val external fetch: (string, {..}) => promise<{..}> = "fetch"

/** Create FormDB client */
let make = (~baseUrl: string, ~apiKey: option<string>=?): formdbClient => {
  let headers = {
    "Content-Type": "application/json",
    "Accept": "application/json",
  }

  let headersWithAuth = switch apiKey {
  | Some(key) => {
      "Content-Type": "application/json",
      "Accept": "application/json",
      "X-API-Key": key,
    }
  | None => headers
  }

  let request = async (method: string, path: string, body: option<Js.Json.t>): Js.Json.t => {
    let url = baseUrl ++ path
    let options = switch body {
    | Some(b) => {
        "method": method,
        "headers": headersWithAuth,
        "body": Js.Json.stringify(b),
      }
    | None => {
        "method": method,
        "headers": headersWithAuth,
      }
    }

    let response = await fetch(url, options)
    let json = await response["json"]()
    json
  }

  {
    query: async (fdql: string): queryResult => {
      let body = Js.Json.object_(
        Js.Dict.fromArray([("fdql", Js.Json.string(fdql))])
      )
      let result = await request("POST", "/v1/query", Some(body))
      {
        rows: result["rows"],
        rowCount: result["rowCount"],
        affectedCount: result["affectedCount"],
      }
    },

    insert: async (collection: string, document: Js.Json.t): queryResult => {
      let fdql = `INSERT INTO ${collection} ${Js.Json.stringify(document)}`
      let body = Js.Json.object_(
        Js.Dict.fromArray([("fdql", Js.Json.string(fdql))])
      )
      let result = await request("POST", "/v1/query", Some(body))
      {
        rows: result["rows"],
        rowCount: result["rowCount"],
        affectedCount: result["affectedCount"],
      }
    },

    update: async (collection: string, document: Js.Json.t, id: string): queryResult => {
      let setClause = Js.Json.stringify(document)
      let fdql = `UPDATE ${collection} SET ${setClause} WHERE id = "${id}"`
      let body = Js.Json.object_(
        Js.Dict.fromArray([("fdql", Js.Json.string(fdql))])
      )
      let result = await request("POST", "/v1/query", Some(body))
      {
        rows: result["rows"],
        rowCount: result["rowCount"],
        affectedCount: result["affectedCount"],
      }
    },

    delete: async (collection: string, id: string): queryResult => {
      let fdql = `DELETE FROM ${collection} WHERE id = "${id}"`
      let body = Js.Json.object_(
        Js.Dict.fromArray([("fdql", Js.Json.string(fdql))])
      )
      let result = await request("POST", "/v1/query", Some(body))
      {
        rows: result["rows"],
        rowCount: result["rowCount"],
        affectedCount: result["affectedCount"],
      }
    },

    health: async (): healthResponse => {
      let result = await request("GET", "/v1/health", None)
      {
        status: result["status"],
        version: result["version"],
      }
    },
  }
}

/** Create client from Strapi config */
let fromStrapiConfig = (config: pluginConfig): formdbClient => {
  make(~baseUrl=config.formdbUrl, ~apiKey=config.apiKey)
}
