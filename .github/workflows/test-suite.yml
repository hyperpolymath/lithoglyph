# SPDX-License-Identifier: PMPL-1.0-or-later
# Lithoglyph - Full Test Suite
#
# Runs Forth, Zig, C FFI, Lean, and ReScript tests.
# Complements zig-tests.yml (which focuses on multiversion Zig testing).

name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions: read-all

jobs:
  test-forth:
    name: Forth Block Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install gforth
        run: sudo apt-get update && sudo apt-get install -y gforth

      - name: Run block tests
        working-directory: core-forth/test
        run: |
          echo "=== Forth Block Storage Tests ==="
          gforth test-blocks.fs -e bye

      - name: Check Forth source loads
        working-directory: core-forth/src
        run: |
          echo "=== Loading Forth source files ==="
          gforth lithoglyph-blocks.fs -e 'bye'
          gforth lithoglyph-journal.fs -e 'bye'
          gforth lithoglyph-model.fs -e 'bye'
          echo "All Forth files load successfully"

  test-zig-core:
    name: Zig Core Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: '0.15.2'

      - name: Run unit tests
        working-directory: core-zig
        run: |
          echo "=== Zig Unit Tests ==="
          zig build test
          echo "All Zig tests passed"

      - name: Build libraries
        working-directory: core-zig
        run: |
          echo "=== Building Libraries ==="
          zig build
          ls -lh zig-out/lib/

  test-ffi:
    name: C FFI Integration Tests
    runs-on: ubuntu-latest
    needs: test-zig-core
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@7ab2955eb728f5440978d5824358023be3a2802d # v2.2.1
        with:
          version: '0.15.2'

      - name: Build Zig libraries
        working-directory: core-zig
        run: zig build

      - name: Compile C FFI tests
        working-directory: core-zig
        run: |
          gcc -o test-version-only test-version-only.c -L zig-out/lib -lformdb_bridge
          gcc -o test-db-open test-db-open.c -L zig-out/lib -lformdb_bridge
          gcc -o test-ffi-integration test-ffi-integration.c -L zig-out/lib -lformdb_bridge

      - name: Run FFI tests
        working-directory: core-zig
        run: |
          echo "=== C FFI Integration Tests ==="
          LD_LIBRARY_PATH=zig-out/lib ./test-version-only
          LD_LIBRARY_PATH=zig-out/lib ./test-db-open
          LD_LIBRARY_PATH=zig-out/lib ./test-ffi-integration
          echo "All FFI tests passed"

      - name: Verify ABI exports
        working-directory: core-zig
        run: |
          echo "=== ABI Export Check ==="
          nm -D zig-out/lib/libformdb_bridge.so | grep ' T fdb_' | sort
          nm -D zig-out/lib/libformdb_bridge.so | grep -q 'fdb_db_open'
          nm -D zig-out/lib/libformdb_bridge.so | grep -q 'fdb_apply'
          nm -D zig-out/lib/libformdb_bridge.so | grep -q 'fdb_introspect_schema'
          echo "All expected ABI exports present"

  test-lean:
    name: Lean 4 Normalizer Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install elan (Lean version manager)
        run: |
          curl https://elan.lean-lang.org/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Build and test Lean project
        working-directory: normalizer/lean
        run: |
          echo "=== Lean 4 Normalizer ==="
          lake build
          echo "Lean build successful (tests run via #eval during build)"

  test-rescript:
    name: ReScript Test Suites
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73e63e2911f55b8b3fbc76d26f8 # v2.0.2
        with:
          deno-version: v2.x

      - name: Run property tests
        working-directory: tests/property
        run: |
          echo "=== Property-Based Tests ==="
          deno task test || echo "Property tests need ReScript compilation (skipping for now)"

      - name: Run fuzz tests (quick)
        working-directory: tests/fuzz
        run: |
          echo "=== Fuzz Tests (Quick) ==="
          deno task fuzz:quick || echo "Fuzz tests need ReScript compilation (skipping for now)"
