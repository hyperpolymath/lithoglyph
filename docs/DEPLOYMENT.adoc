// SPDX-License-Identifier: PMPL-1.0
= FormDB Deployment Guide
:toc: macro
:toc-title: Contents
:toclevels: 3
:icons: font
:sectnums:

[.lead]
How to deploy FormDB in development, staging, and production environments.

[NOTE]
====
**Project Status: Proof of Concept**

FormDB is in active development. This guide describes the intended deployment model. Some features are planned but not yet implemented (marked with ğŸš§).
====

toc::[]

== Overview

FormDB can be deployed in several configurations:

[cols="1,2,2"]
|===
| Mode | Use Case | Components

| **Embedded**
| Single application, local data
| Form.Blocks + Form.Model only

| **Standalone**
| Single server, multiple clients
| Full stack without clustering

| **Clustered**
| High availability, horizontal scale
| Full stack with Elixir control plane

| **Serverless** ğŸš§
| Event-driven, auto-scaling
| Cloud-native with object storage
|===

== Development Setup

=== Prerequisites

[cols="1,1,2,1"]
|===
| Tool | Version | Purpose | Required

| https://github.com/cisco/gforth[Gforth]
| 0.7.3+
| Form.Blocks, Form.Model (truth core)
| Yes

| https://factorcode.org/[Factor]
| 0.99+
| Form.Runtime (FQL parser/executor)
| Yes

| https://ziglang.org/[Zig]
| 0.11+
| Form.Bridge (stable ABI)
| Yes

| https://just.systems/[just]
| 1.0+
| Build orchestration
| Yes

| https://elixir-lang.org/[Elixir]
| 1.15+
| Form.ControlPlane (clustering)
| Optional

| https://www.docker.com/[Docker]
| 24.0+
| Container deployment
| Optional

| https://leanprover.github.io/[Lean 4]
| 4.0+
| FQLdt proofs (experimental)
| Optional
|===

=== Installation

.Fedora/RHEL
[source,bash]
----
# Core dependencies
sudo dnf install gforth

# Zig (manual install)
curl -LO https://ziglang.org/download/0.11.0/zig-linux-x86_64-0.11.0.tar.xz
tar xf zig-linux-x86_64-0.11.0.tar.xz
sudo mv zig-linux-x86_64-0.11.0 /opt/zig
echo 'export PATH=$PATH:/opt/zig' >> ~/.bashrc

# Just
curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

# Factor (manual install from factorcode.org)

# Optional: Elixir for control plane
sudo dnf install elixir erlang
----

.Ubuntu/Debian
[source,bash]
----
sudo apt update
sudo apt install gforth

# Zig, Just, Factor: see Fedora instructions or use official sources

# Optional: Elixir
sudo apt install elixir erlang-dev
----

.macOS
[source,bash]
----
brew install gforth zig just elixir
# Factor: download from factorcode.org
----

.NixOS / Nix
[source,nix]
----
# shell.nix
{ pkgs ? import <nixpkgs> {} }:
pkgs.mkShell {
  buildInputs = with pkgs; [
    gforth
    zig
    just
    factor-lang
    elixir
    erlang
  ];
}
----

=== Clone and Verify

[source,bash]
----
git clone https://github.com/hyperpolymath/formdb.git
cd formdb

# Verify Gforth loads the core
gforth core-forth/src/formdb-blocks.fs -e "cr .\" OK\" cr bye"

# Run tests (when available)
just test
----

=== Development Server

[source,bash]
----
# Start development server with hot reload
just dev

# Or manually:
# 1. Start the Forth core
gforth core-forth/src/formdb-blocks.fs \
       core-forth/src/formdb-journal.fs \
       core-forth/src/formdb-model.fs

# 2. Start the Factor runtime (when available)
factor -run=formdb.runtime

# 3. Optional: Start Elixir control plane
cd control-plane && mix phx.server
----

== Standalone Deployment

Single-server deployment for small to medium workloads.

=== Architecture

[source,text]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Client Applications                     â”‚
â”‚              (FQL queries via HTTP/gRPC/Zig FFI)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Form.ControlPlane (Elixir/OTP) - Optional                  â”‚
â”‚  â”œâ”€â”€ HTTP/gRPC API endpoints                                â”‚
â”‚  â”œâ”€â”€ Connection pooling                                     â”‚
â”‚  â”œâ”€â”€ Session management                                     â”‚
â”‚  â””â”€â”€ Metrics collection                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Form.Runtime (Factor)                                      â”‚
â”‚  â”œâ”€â”€ FQL parser and planner                                 â”‚
â”‚  â”œâ”€â”€ Query execution                                        â”‚
â”‚  â””â”€â”€ Introspection and explain                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Form.Bridge (Zig)                                          â”‚
â”‚  â”œâ”€â”€ Stable ABI for FFI                                     â”‚
â”‚  â””â”€â”€ Safety governor                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Form.Model (Forth)                                         â”‚
â”‚  â”œâ”€â”€ Document collections                                   â”‚
â”‚  â”œâ”€â”€ Edge collections                                       â”‚
â”‚  â””â”€â”€ Schema/constraint management                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Form.Blocks (Forth)                                        â”‚
â”‚  â”œâ”€â”€ 4 KiB block storage                                    â”‚
â”‚  â”œâ”€â”€ Append-only journal                                    â”‚
â”‚  â””â”€â”€ Integrity verification                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Storage Layer                                              â”‚
â”‚  â””â”€â”€ Local SSD / NVMe (recommended)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

=== Configuration

FormDB uses a hierarchical configuration system:

[source,text]
----
Priority (highest to lowest):
1. Environment variables (FORMDB_*)
2. Command-line flags
3. Config file (formdb.toml or formdb.ncl)
4. Built-in defaults
----

==== Configuration File

.formdb.toml
[source,toml]
----
[server]
bind = "0.0.0.0"
port = 5432
max_connections = 100

[storage]
data_dir = "/var/lib/formdb/data"
journal_dir = "/var/lib/formdb/journal"
block_size = 4096  # Do not change after init

[journal]
sync_mode = "fsync"  # fsync, fdatasync, async
checkpoint_interval = "5m"
max_segment_size = "256MB"

[limits]
max_document_size = "16MB"
max_query_time = "30s"
max_result_size = "100MB"

[security]
require_provenance = true
min_rationale_length = 10

[logging]
level = "info"  # trace, debug, info, warn, error
format = "json"
output = "/var/log/formdb/formdb.log"

[metrics]
enabled = true
port = 9090
path = "/metrics"
----

==== Environment Variables

[cols="2,1,2"]
|===
| Variable | Default | Description

| `FORMDB_DATA_DIR`
| `./data`
| Data directory path

| `FORMDB_JOURNAL_DIR`
| `./journal`
| Journal directory path

| `FORMDB_BIND`
| `127.0.0.1`
| Bind address

| `FORMDB_PORT`
| `5432`
| Listen port

| `FORMDB_LOG_LEVEL`
| `info`
| Log verbosity

| `FORMDB_SYNC_MODE`
| `fsync`
| Journal sync mode

| `FORMDB_MAX_CONNECTIONS`
| `100`
| Maximum client connections

| `FORMDB_REQUIRE_PROVENANCE`
| `true`
| Require provenance on mutations
|===

=== Directory Structure

[source,text]
----
/var/lib/formdb/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ superblock.fdb       # Database metadata
â”‚   â”œâ”€â”€ collections/
â”‚   â”‚   â”œâ”€â”€ evidence.fdb     # Collection blocks
â”‚   â”‚   â””â”€â”€ claims.fdb
â”‚   â””â”€â”€ edges/
â”‚       â””â”€â”€ supports.fdb     # Edge blocks
â”œâ”€â”€ journal/
â”‚   â”œâ”€â”€ 000001.journal       # Journal segments
â”‚   â”œâ”€â”€ 000002.journal
â”‚   â””â”€â”€ checkpoint.meta      # Last checkpoint
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ v1/                  # Schema versions
â””â”€â”€ config/
    â””â”€â”€ formdb.toml          # Configuration
----

=== Systemd Service

./etc/systemd/system/formdb.service
[source,ini]
----
[Unit]
Description=FormDB Database Server
Documentation=https://github.com/hyperpolymath/formdb
After=network.target

[Service]
Type=notify
User=formdb
Group=formdb
ExecStart=/usr/local/bin/formdb serve --config /etc/formdb/formdb.toml
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5s

# Security hardening
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/formdb /var/log/formdb
PrivateTmp=true

# Resource limits
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
----

Enable and start:

[source,bash]
----
sudo systemctl daemon-reload
sudo systemctl enable formdb
sudo systemctl start formdb
sudo systemctl status formdb
----

== Resource Sizing

=== Minimum Requirements

[cols="1,1,2"]
|===
| Resource | Minimum | Notes

| CPU
| 2 cores
| Single-threaded Forth core + Factor runtime

| RAM
| 4 GB
| 2 GB for runtime, 2 GB for OS/buffers

| Storage
| 20 GB SSD
| SSD required, HDD not supported

| Network
| 100 Mbps
| For client connections
|===

=== Recommended (Production)

[cols="1,1,2"]
|===
| Resource | Recommended | Notes

| CPU
| 8+ cores
| Parallelism in control plane

| RAM
| 32 GB
| More RAM = larger buffer cache

| Storage
| 500 GB NVMe
| Low latency critical for journal

| Network
| 1 Gbps+
| For replication and client traffic
|===

=== Sizing Guidelines

[cols="1,1,1,1"]
|===
| Workload | Documents | Daily Writes | Recommended Spec

| Small
| < 100K
| < 10K
| 2 CPU, 4 GB, 50 GB SSD

| Medium
| 100K - 1M
| 10K - 100K
| 4 CPU, 16 GB, 200 GB NVMe

| Large
| 1M - 10M
| 100K - 1M
| 8 CPU, 64 GB, 1 TB NVMe

| Enterprise
| 10M+
| 1M+
| 16+ CPU, 128+ GB, RAID NVMe
|===

=== Storage Calculations

[source,text]
----
Estimated storage per document:
  Block overhead: 64 bytes (header)
  Average document: ~500 bytes
  Journal entry: ~200 bytes
  Total per document: ~764 bytes

For 1 million documents:
  Data: ~500 MB
  Journal: ~200 MB (grows with writes)
  Indexes: ~100 MB
  Total: ~800 MB + journal history

Journal retention:
  Keep all: Unlimited audit trail
  Keep 90 days: Typical for compliance
  Keep 7 days: Minimal (not recommended)
----

== Docker Deployment

=== Docker Image ğŸš§

[source,dockerfile]
----
# Dockerfile
FROM debian:bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    gforth \
    curl \
    xz-utils \
    && rm -rf /var/lib/apt/lists/*

# Install Zig
RUN curl -LO https://ziglang.org/download/0.11.0/zig-linux-x86_64-0.11.0.tar.xz \
    && tar xf zig-linux-x86_64-0.11.0.tar.xz \
    && mv zig-linux-x86_64-0.11.0 /opt/zig

# Copy source and build
WORKDIR /app
COPY . .
RUN PATH=$PATH:/opt/zig just build

# Runtime image
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y gforth && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/target/formdb /usr/local/bin/
COPY --from=builder /app/core-forth /opt/formdb/core-forth

# Create formdb user
RUN useradd -r -s /bin/false formdb \
    && mkdir -p /var/lib/formdb /var/log/formdb \
    && chown -R formdb:formdb /var/lib/formdb /var/log/formdb

USER formdb
WORKDIR /var/lib/formdb

EXPOSE 5432 9090

VOLUME ["/var/lib/formdb"]

ENTRYPOINT ["formdb"]
CMD ["serve"]
----

=== Docker Compose

.docker-compose.yml
[source,yaml]
----
version: '3.8'

services:
  formdb:
    image: hyperpolymath/formdb:latest
    container_name: formdb
    ports:
      - "5432:5432"   # Main port
      - "9090:9090"   # Metrics
    volumes:
      - formdb-data:/var/lib/formdb
      - ./formdb.toml:/etc/formdb/formdb.toml:ro
    environment:
      - FORMDB_LOG_LEVEL=info
      - FORMDB_SYNC_MODE=fsync
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "formdb", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  formdb-data:
    driver: local
----

Run:

[source,bash]
----
docker-compose up -d
docker-compose logs -f formdb
----

=== Docker Commands

[source,bash]
----
# Run standalone
docker run -d \
  --name formdb \
  -p 5432:5432 \
  -v formdb-data:/var/lib/formdb \
  hyperpolymath/formdb:latest

# Execute FQL query
docker exec formdb formdb query 'SELECT * FROM evidence;'

# Backup
docker exec formdb formdb backup /backup
docker cp formdb:/backup ./formdb-backup-$(date +%Y%m%d)

# View logs
docker logs -f formdb

# Health check
docker exec formdb formdb health
----

== Kubernetes Deployment ğŸš§

=== Helm Chart

[source,bash]
----
# Add Helm repository
helm repo add hyperpolymath https://charts.hyperpolymath.dev
helm repo update

# Install FormDB
helm install formdb hyperpolymath/formdb \
  --namespace formdb \
  --create-namespace \
  --set persistence.size=100Gi \
  --set resources.requests.memory=8Gi

# Upgrade
helm upgrade formdb hyperpolymath/formdb \
  --namespace formdb \
  --set image.tag=0.1.0
----

=== Kubernetes Manifests

.formdb-deployment.yaml
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: formdb
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: formdb-data
  namespace: formdb
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd  # Use SSD storage class
  resources:
    requests:
      storage: 100Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: formdb
  namespace: formdb
spec:
  serviceName: formdb
  replicas: 1  # Single node for standalone
  selector:
    matchLabels:
      app: formdb
  template:
    metadata:
      labels:
        app: formdb
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: formdb
          image: hyperpolymath/formdb:latest
          ports:
            - containerPort: 5432
              name: formdb
            - containerPort: 9090
              name: metrics
          volumeMounts:
            - name: data
              mountPath: /var/lib/formdb
            - name: config
              mountPath: /etc/formdb
          resources:
            requests:
              cpu: "2"
              memory: 8Gi
            limits:
              cpu: "4"
              memory: 16Gi
          livenessProbe:
            exec:
              command: ["formdb", "health"]
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["formdb", "health", "--ready"]
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: formdb-data
        - name: config
          configMap:
            name: formdb-config
---
apiVersion: v1
kind: Service
metadata:
  name: formdb
  namespace: formdb
spec:
  selector:
    app: formdb
  ports:
    - port: 5432
      targetPort: 5432
      name: formdb
    - port: 9090
      targetPort: 9090
      name: metrics
----

== Cloud Provider Guides

=== AWS

==== EC2 Deployment

[source,bash]
----
# Recommended instance types
# - Development: t3.medium (2 vCPU, 4 GB)
# - Production: r6i.xlarge (4 vCPU, 32 GB)
# - High-performance: r6i.4xlarge (16 vCPU, 128 GB)

# Use gp3 or io2 EBS volumes for storage
# Minimum IOPS: 3000 (gp3 default)
# Recommended: 10000+ IOPS for production
----

==== EBS Configuration

[source,bash]
----
# Create optimized EBS volume
aws ec2 create-volume \
  --availability-zone us-east-1a \
  --size 500 \
  --volume-type gp3 \
  --iops 10000 \
  --throughput 500 \
  --tag-specifications 'ResourceType=volume,Tags=[{Key=Name,Value=formdb-data}]'
----

==== S3 for Backups

[source,bash]
----
# Backup to S3
formdb backup /tmp/backup
aws s3 sync /tmp/backup s3://my-bucket/formdb-backups/$(date +%Y%m%d)/

# Restore from S3
aws s3 sync s3://my-bucket/formdb-backups/20260112/ /tmp/restore
formdb restore /tmp/restore
----

=== Google Cloud Platform

==== Compute Engine

[source,bash]
----
# Recommended machine types
# - Development: e2-medium (2 vCPU, 4 GB)
# - Production: n2-highmem-4 (4 vCPU, 32 GB)
# - High-performance: n2-highmem-16 (16 vCPU, 128 GB)

# Create VM with SSD
gcloud compute instances create formdb-server \
  --machine-type=n2-highmem-4 \
  --zone=us-central1-a \
  --boot-disk-size=50GB \
  --boot-disk-type=pd-ssd \
  --create-disk=name=formdb-data,size=500GB,type=pd-ssd,auto-delete=no
----

==== Cloud Storage for Backups

[source,bash]
----
# Backup to GCS
formdb backup /tmp/backup
gsutil -m rsync -r /tmp/backup gs://my-bucket/formdb-backups/$(date +%Y%m%d)/
----

=== Azure

==== Virtual Machines

[source,bash]
----
# Recommended VM sizes
# - Development: Standard_D2s_v3 (2 vCPU, 8 GB)
# - Production: Standard_E4s_v3 (4 vCPU, 32 GB)
# - High-performance: Standard_E16s_v3 (16 vCPU, 128 GB)

# Create VM with Premium SSD
az vm create \
  --resource-group formdb-rg \
  --name formdb-server \
  --size Standard_E4s_v3 \
  --image Debian:debian-12:12:latest \
  --data-disk-sizes-gb 500 \
  --storage-sku Premium_LRS
----

== High Availability ğŸš§

=== Clustered Architecture

[source,text]
----
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load Balancer  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FormDB Node 1  â”‚ â”‚  FormDB Node 2  â”‚ â”‚  FormDB Node 3  â”‚
â”‚  (Primary)      â”‚ â”‚  (Replica)      â”‚ â”‚  (Replica)      â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚  Control Plane  â”‚ â”‚  Control Plane  â”‚ â”‚  Control Plane  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Runtime        â”‚ â”‚  Runtime        â”‚ â”‚  Runtime        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Storage        â”‚ â”‚  Storage        â”‚ â”‚  Storage        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Shared Journal â”‚
                    â”‚  (Raft/Paxos)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

=== Replication Modes

[cols="1,2,2"]
|===
| Mode | Description | Use Case

| **Synchronous**
| All replicas confirm before commit
| Maximum durability, highest latency

| **Asynchronous**
| Primary confirms immediately
| Lower latency, potential data loss

| **Semi-synchronous**
| At least one replica confirms
| Balance of durability and latency
|===

== Backup and Recovery

=== Backup Strategy

[source,bash]
----
# Full backup
formdb backup --full /backup/full-$(date +%Y%m%d)

# Incremental backup (journal segments since last backup)
formdb backup --incremental --since 1000 /backup/incr-$(date +%Y%m%d)

# Continuous backup (stream journal to remote)
formdb backup --stream s3://my-bucket/formdb-journal/
----

=== Backup Schedule

[cols="1,2,2"]
|===
| Type | Frequency | Retention

| Full backup
| Weekly (Sunday 02:00)
| 4 weeks

| Incremental
| Daily (02:00)
| 7 days

| Journal stream
| Continuous
| 90 days
|===

=== Recovery

[source,bash]
----
# Restore from full backup
formdb restore /backup/full-20260112

# Restore to point in time
formdb restore /backup/full-20260112 --to-sequence 5000

# Restore to timestamp
formdb restore /backup/full-20260112 --to-time "2026-01-12T10:30:00Z"

# Verify restoration
formdb doctor --verify
----

== Upgrades

=== Upgrade Process

[source,bash]
----
# 1. Check compatibility
formdb doctor --check-upgrade --to-version 0.2.0

# 2. Backup current state
formdb backup --full /backup/pre-upgrade-$(date +%Y%m%d)

# 3. Stop service
sudo systemctl stop formdb

# 4. Install new version
# (package manager or manual)

# 5. Run migrations if needed
formdb migrate --to-version 0.2.0

# 6. Start service
sudo systemctl start formdb

# 7. Verify
formdb doctor --verify
formdb query 'INTROSPECT VERSION;'
----

=== Rollback

[source,bash]
----
# If upgrade fails
sudo systemctl stop formdb

# Restore previous version binary
# ...

# Restore from backup
formdb restore /backup/pre-upgrade-20260112

sudo systemctl start formdb
----

== Health Checks

=== CLI Health Check

[source,bash]
----
# Basic health
formdb health

# Detailed health
formdb health --verbose

# Output:
# FormDB Health Check
# ===================
# Status: HEALTHY
#
# Components:
#   Storage: OK (500 GB free)
#   Journal: OK (1523 entries, synced)
#   Runtime: OK (uptime: 5d 12h)
#   Connections: OK (12/100)
#
# Last checkpoint: 2026-01-12T10:00:00Z
# Journal lag: 0 entries
----

=== HTTP Health Endpoints

[cols="1,1,2"]
|===
| Endpoint | Response | Purpose

| `GET /health`
| 200 OK
| Basic liveness

| `GET /health/ready`
| 200 OK / 503
| Readiness (can accept queries)

| `GET /health/live`
| 200 OK / 503
| Liveness (process running)

| `GET /health/storage`
| JSON status
| Storage subsystem health

| `GET /health/journal`
| JSON status
| Journal subsystem health
|===

== Troubleshooting

=== Common Issues

==== "Permission denied" on data directory

[source,bash]
----
# Fix ownership
sudo chown -R formdb:formdb /var/lib/formdb

# Fix permissions
sudo chmod -R 750 /var/lib/formdb
----

==== "Journal sync failed"

[source,bash]
----
# Check disk space
df -h /var/lib/formdb

# Check disk I/O
iostat -x 1

# Switch to async mode temporarily (data loss risk!)
FORMDB_SYNC_MODE=async formdb serve
----

==== "Too many open files"

[source,bash]
----
# Check current limit
ulimit -n

# Increase limit
sudo bash -c 'echo "formdb soft nofile 65536" >> /etc/security/limits.conf'
sudo bash -c 'echo "formdb hard nofile 65536" >> /etc/security/limits.conf'

# For systemd service, add to [Service]:
# LimitNOFILE=65536
----

==== "Out of memory"

[source,bash]
----
# Check memory usage
free -h
ps aux | grep formdb

# Reduce buffer cache (in formdb.toml)
# [storage]
# buffer_cache_size = "1GB"
----

== See Also

* link:OBSERVABILITY.adoc[Observability Guide] - Monitoring and metrics
* link:SECURITY-AUTH.adoc[Security & Auth] - Authentication and hardening
* link:../ARCHITECTURE.adoc[Architecture Guide] - System design
* link:../VERSIONING.adoc[Versioning Policy] - Upgrade compatibility
